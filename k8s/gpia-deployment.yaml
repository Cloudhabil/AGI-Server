---
# GPIA Autonomous Agent - Kubernetes Deployment
# ==============================================
#
# Deploy: kubectl apply -f k8s/
#
# What survives without human intervention:
# - Goals (PersistentVolume)
# - Task queue (PersistentVolume)
# - Memory/experiences (PersistentVolume)
# - Health state (PersistentVolume)
# - Container restarts (Deployment)
# - Node failures (K8s scheduler)
#
# What needs external services:
# - Ollama (separate deployment or host network)

apiVersion: v1
kind: Namespace
metadata:
  name: gpia
  labels:
    app: gpia

---
# Persistent Volume Claim - Agent brain survives restarts
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gpia-data
  namespace: gpia
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard  # Adjust for your cluster

---
# ConfigMap - Agent configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: gpia-config
  namespace: gpia
data:
  # Initial goals - loaded on first boot
  initial-goals.json: |
    {
      "goals": [
        {
          "id": "health-check",
          "description": "Check system health and report status",
          "priority": 1,
          "schedule": "1h",
          "enabled": true
        },
        {
          "id": "memory-consolidate",
          "description": "Consolidate and organize memories from recent experiences",
          "priority": 3,
          "schedule": "6h",
          "enabled": true
        },
        {
          "id": "self-improve",
          "description": "Analyze recent failures and suggest improvements",
          "priority": 2,
          "schedule": "24h",
          "enabled": true
        }
      ]
    }

---
# Deployment - The autonomous agent
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gpia
  namespace: gpia
  labels:
    app: gpia
spec:
  replicas: 1  # Single brain - increase only with leader election
  selector:
    matchLabels:
      app: gpia
  template:
    metadata:
      labels:
        app: gpia
    spec:
      terminationGracePeriodSeconds: 30

      # Init container - copy initial goals if not exist
      initContainers:
        - name: init-goals
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              if [ ! -f /data/gpia/goals.json ]; then
                echo "Initializing goals..."
                mkdir -p /data/gpia
                cp /config/initial-goals.json /data/gpia/goals.json
              fi
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /config

      containers:
        - name: gpia
          image: gpia:latest  # Build with Dockerfile
          imagePullPolicy: IfNotPresent

          command:
            - python
            - gpia_autonomous.py
            - --mode
            - daemon
            - --interval
            - "60"

          env:
            - name: GPIA_DATA_DIR
              value: "/data/gpia"
            - name: OLLAMA_URL
              value: "http://ollama:11434/api/generate"
            - name: PYTHONUNBUFFERED
              value: "1"

          volumeMounts:
            - name: data
              mountPath: /data

          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"

          # Health checks
          livenessProbe:
            exec:
              command:
                - cat
                - /data/gpia/health.json
            initialDelaySeconds: 30
            periodSeconds: 60
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - python
                - -c
                - "import json; h=json.load(open('/data/gpia/health.json')); exit(0 if h.get('alive') else 1)"
            initialDelaySeconds: 10
            periodSeconds: 30

          # Lifecycle hooks
          lifecycle:
            preStop:
              exec:
                command:
                  - python
                  - -c
                  - "import json; h=json.load(open('/data/gpia/health.json')); h['alive']=False; json.dump(h, open('/data/gpia/health.json','w'))"

      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: gpia-data
        - name: config
          configMap:
            name: gpia-config

      # Keep it running
      restartPolicy: Always

---
# Service - For health checks and API access
apiVersion: v1
kind: Service
metadata:
  name: gpia
  namespace: gpia
spec:
  selector:
    app: gpia
  ports:
    - port: 8080
      targetPort: 8080
      name: api
  type: ClusterIP

---
# CronJob - External trigger example
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gpia-daily-review
  namespace: gpia
spec:
  schedule: "0 6 * * *"  # 6 AM daily
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: trigger
              image: curlimages/curl:8.1.2
              command:
                - sh
                - -c
                - |
                  # Add a daily review goal/task
                  echo "Triggering daily review..."
          restartPolicy: OnFailure

---
# NetworkPolicy - Security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gpia-network
  namespace: gpia
spec:
  podSelector:
    matchLabels:
      app: gpia
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
  egress:
    # Allow Ollama
    - to:
        - podSelector:
            matchLabels:
              app: ollama
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
