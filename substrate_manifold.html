<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Substrate Manifold (Machine-Readable)</title>
  <!--
    Purpose: machine-readable map from 841 skills to a 384-D tensor manifold.
    This file is not for human viewing; data lives in <data> nodes and is
    consumed by automation. Populate `skills` with 841 vectors before use.

    Expected inputs:
    - Intent vector: Float64Array length 384 (NPU-produced).
    - Skill vectors: 841 entries, each {id, path, v:[384 floats]}.

    How to populate (outline):
      1) Run your NPU embedding pipeline over all manifests in src/skills/ and skills/.
      2) Emit JSON with keys: dim (384), skills (array of {id, path, v}).
      3) Inject into the <data id="manifold-skills"> node or assign
         `window.MANIFOLD_VECTORS = {dim:384, skills:[...]}` before collapse().
  -->
</head>
<body>
  <data id="manifold-meta" type="application/json">
    {"expected_skills":841,"dim":384,"metric":"riemann_identity"}
  </data>

  <!-- Placeholder; replace `skills` with the 841 vectors. -->
  <data id="manifold-skills" type="application/json">
    {"dim":384,"skills":[]}
  </data>

  <script type="application/javascript">
    // Simple Riemannian metric (identity). Replace G with a 384x384 SPD matrix if available.
    function riemannDistance(intent, skillVec, G) {
      const dim = intent.length;
      let acc = 0;
      for (let i = 0; i < dim; i++) {
        const diff = intent[i] - skillVec[i];
        const g = G ? G[i * dim + i] : 1; // diagonal-only for speed
        acc += diff * g * diff;
      }
      return Math.sqrt(acc);
    }

    function loadManifold() {
      // Try global first, then <data> fallback
      if (window.MANIFOLD_VECTORS) return window.MANIFOLD_VECTORS;
      const node = document.getElementById('manifold-skills');
      if (!node) throw new Error('Manifold data node missing');
      return JSON.parse(node.textContent || '{}');
    }

    function validateManifold(m) {
      if (!m || !Array.isArray(m.skills)) throw new Error('Invalid manifold payload');
      if (m.skills.length !== 841) console.warn(`Expected 841 skills, found ${m.skills.length}`);
      for (const s of m.skills) {
        if (!Array.isArray(s.v) || s.v.length !== 384) throw new Error(`Bad vector for skill ${s.id}`);
      }
      return m;
    }

    function collapse(intentVector, manifold, metric) {
      const m = validateManifold(manifold || loadManifold());
      if (!Array.isArray(intentVector) || intentVector.length !== 384) {
        throw new Error('Intent vector must be length 384');
      }
      const G = metric || null; // placeholder for future SPD metric
      let best = null;
      let bestD = Infinity;
      for (const skill of m.skills) {
        const d = riemannDistance(intentVector, skill.v, G);
        if (d < bestD) {
          bestD = d;
          best = skill;
        }
      }
      return {skill: best, distance: bestD};
    }

    // Export for automation
    window.SubstrateManifold = { loadManifold, collapse, validateManifold };
  </script>
</body>
</html>
