version: '3.8'

# RH Adaptive Ensemble - Each student in isolated container with own model
# Achieves homogeneous flow: models always warm, no cold-start spikes

services:
  # Orchestrator - Main coordinator
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rh-orchestrator
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
      PYTHONUNBUFFERED: "1"
    ports:
      - "8000:8000"  # Orchestrator API
    volumes:
      - ./agents/sessions:/app/agents/sessions
      - ./memory:/app/memory
    depends_on:
      - alpha
      - beta
      - gamma
      - delta
      - epsilon
      - zeta
    command: python -c "
      import time
      time.sleep(2)  # Wait for students to be ready
      from orchestrator_multi_student import RHMultiStudentEnsemble
      ensemble = RHMultiStudentEnsemble(duration_minutes=10, session_name='rh_k8s_ensemble')
      ensemble.run()
    networks:
      - rh-network

  # Student Alpha - nous-hermes:7b
  alpha:
    image: ollama/ollama:latest
    container_name: rh-student-alpha
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
    ports:
      - "11435:11434"
    volumes:
      - ollama-alpha:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 3 &&
      ollama pull nous-hermes:7b &&
      wait"
    networks:
      - rh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Student Beta - llama2:7b
  beta:
    image: ollama/ollama:latest
    container_name: rh-student-beta
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
    ports:
      - "11436:11434"
    volumes:
      - ollama-beta:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 3 &&
      ollama pull llama2:7b &&
      wait"
    networks:
      - rh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Student Gamma - mistral:latest
  gamma:
    image: ollama/ollama:latest
    container_name: rh-student-gamma
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
    ports:
      - "11437:11434"
    volumes:
      - ollama-gamma:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 3 &&
      ollama pull mistral:latest &&
      wait"
    networks:
      - rh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Student Delta - nous-hermes:7b
  delta:
    image: ollama/ollama:latest
    container_name: rh-student-delta
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
    ports:
      - "11438:11434"
    volumes:
      - ollama-delta:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 3 &&
      ollama pull nous-hermes:7b &&
      wait"
    networks:
      - rh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Student Epsilon - llama2:7b
  epsilon:
    image: ollama/ollama:latest
    container_name: rh-student-epsilon
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
    ports:
      - "11439:11434"
    volumes:
      - ollama-epsilon:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 3 &&
      ollama pull llama2:7b &&
      wait"
    networks:
      - rh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Student Zeta - mistral:latest
  zeta:
    image: ollama/ollama:latest
    container_name: rh-student-zeta
    environment:
      OLLAMA_HOST: "0.0.0.0:11434"
    ports:
      - "11440:11434"
    volumes:
      - ollama-zeta:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 3 &&
      ollama pull mistral:latest &&
      wait"
    networks:
      - rh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  ollama-alpha:
  ollama-beta:
  ollama-gamma:
  ollama-delta:
  ollama-epsilon:
  ollama-zeta:

networks:
  rh-network:
    driver: bridge
