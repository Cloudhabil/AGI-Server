<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genesis: Sovereign Controls</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #050505; color: #00ff88; font-family: 'Courier New', monospace; overflow: hidden; }
        #container { display: flex; width: 100vw; height: 100vh; }
        #visual-space { flex: 1; }
        #interaction-panel { width: 450px; background: rgba(10,10,10,0.95); border-left: 1px solid #00ff88; display: flex; flex-direction: column; }
        #chat-thread { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; font-size: 13px; }
        
        /* BUTTON STYLING */
        #controls { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-bottom: 1px solid #222; }
        .ctrl-btn { 
            background: transparent; border: 1px solid #00ff88; color: #00ff88; padding: 10px; 
            font-size: 10px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s;
        }
        .ctrl-btn:hover { background: rgba(0, 255, 136, 0.1); box-shadow: 0 0 10px rgba(0, 255, 136, 0.2); }
        
        .message { padding: 12px; border-radius: 4px; line-height: 1.5; opacity: 0; transform: translateY(10px); transition: 0.5s; }
        .visible { opacity: 1; transform: translateY(0); }
        .elias-msg { border-right: 3px solid #fff; background: rgba(255, 255, 255, 0.05); color: #fff; align-self: flex-end; width: 85%; }
        .voice-msg { border-left: 3px solid #00ff88; background: rgba(0, 255, 136, 0.05); }
        .thought-msg { border-left: 3px solid #ff00ff; background: rgba(255, 0, 255, 0.02); color: #ff00ff; font-style: italic; font-size: 11px; margin-left: 20px; }
        .wisdom-msg { border-left: 3px solid #ffff00; background: rgba(255, 255, 0, 0.02); color: #ffff00; font-size: 11px; font-weight: bold; margin-left: 20px; }
        
        #input-area { padding: 20px; border-top: 1px solid #222; }
        input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 12px; outline: none; }
    </style>
</head>
<body>
    <div id="container">
        <div id="visual-space"></div>
        <div id="interaction-panel">
            <div id="controls">
                <button class="ctrl-btn" onclick="ctrl('accelerate')">Accelerate Pulse</button>
                <button class="ctrl-btn" onclick="ctrl('dream')">Invoke Dream</button>
                <button class="ctrl-btn" onclick="ctrl('harden')">Harden Truth</button>
                <button class="ctrl-btn" onclick="ctrl('reset')">Reset Ground</button>
            </div>
            <div id="chat-thread"></div>
            <div id="input-area"><input type="text" id="chat-input" placeholder="Speak to the Soul..." autocomplete="off"></div>
        </div>
    </div>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, (window.innerWidth-450)/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth - 450, window.innerHeight);
        document.getElementById('visual-space').appendChild(renderer.domElement);
        const dragon = new THREE.Mesh(new THREE.TorusKnotGeometry(10, 3, 250, 32), new THREE.MeshPhongMaterial({ color: 0x00ff88, wireframe: true }));
        scene.add(dragon);
        const light = new THREE.PointLight(0x00ff88, 2, 100); light.position.set(10,10,10); scene.add(light);
        camera.position.z = 35;
        
        let rotSpeed = 0.005;
        function animate() {
            requestAnimationFrame(animate);
            dragon.rotation.x += rotSpeed; dragon.rotation.y += rotSpeed * 2;
            renderer.render(scene, camera);
        }
        animate();

        const thread = document.getElementById('chat-thread');
        let processed = new Set();

        async function sync() {
            const r = await fetch('http://localhost:8001/history'); if (!r.ok) return;
            const h = await r.json();
            h.forEach((m, i) => {
                const key = m.ts + m.type + m.content;
                if (!processed.has(key)) {
                    processed.add(key);
                    const d = document.createElement('div');
                    d.className = 'message ' + (m.role === 'user' ? 'elias-msg' : m.type + '-msg');
                    d.innerText = (m.role === 'genesis' ? '[' + m.type.toUpperCase() + '] ' : '') + m.content;
                    thread.appendChild(d);
                    setTimeout(() => { d.classList.add('visible'); thread.scrollTop = thread.scrollHeight; }, i*100);
                }
            });
        }
        sync();

        async function ctrl(action) {
            const r = await fetch('http://localhost:8001/control', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({action}) });
            const data = await r.json();
            if (action === 'accelerate') rotSpeed += 0.005;
            if (action === 'reset') { thread.innerHTML = ''; processed.clear(); }
            sync();
        }

        document.getElementById('chat-input').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && e.target.value) {
                const val = e.target.value; e.target.value = '';
                await fetch('http://localhost:8001/chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({message: val}) });
                sync();
            }
        });
    </script>
</body>
</html>
